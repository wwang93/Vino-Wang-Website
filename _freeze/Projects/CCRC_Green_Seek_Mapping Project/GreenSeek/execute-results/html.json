{
  "hash": "d080370baad0eb1f2a3c67e8e8fe4192",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"CCRC Green Seek: Mapping Community College Green Sector Alignment\"\nauthor: \"Wei Wang\"\ndate: \"2025-05-04\"\ncategories: [\"Web\", \"Shiny\", \"Mapping\", \"R\", \"JavaScript\"]\ndescription: \"An interactive visualization tool illustrating alignment between community college green program completions and green sector job demand.\"\npage-layout: full\ntitle-block-banner: true\nexecute:\n  echo: false\n---\n\n# 1. Project Background\n\nThis report summarizes the visualization component of the research project **“Examining Community College Student Enrollment and Completions in Green Sector Occupations”**, a joint effort by the Community College Research Center (CCRC) and the University of Tennessee, Knoxville. My role was to design and implement an **interactive visualization tool** that shows how community college green program completions (“supply”) align with green-sector job postings (“demand”).\n\nCommunity colleges need to align their training programs with the rapidly growing green economy, while also ensuring equitable access. However, a nationwide, interactive visualization of this alignment is currently lacking. Our project addresses this gap by:\n\n-   **Supply**: Tracking completions in green programs from IPEDS (2012–2022).\\\n-   **Demand**: Mapping green job postings from Lightcast (2010–2024), aggregated by Commuting Zone (CZ).\\\n-   **Classification**: Applying O\\*NET “Greening of Work” categories.\n\n# 2. Data Sources\n\n## 2.1 IPEDS Supply Data\n\n-   **File**: `ccrc_cip_comp.dta`\\\n-   **Key Fields**: `unitid`, `instnm`, `latitude`, `longitude`, `year`, `greencat`, `cmplt_tot`\n\n## 2.2 Lightcast Demand Data\n\n-   **File**: `lightcast-soc-year-county.csv`\\\n-   **Fields**: `COUNTY` (FIPS), `YEAR`, `SOC_CODE`, `JOB_POSTING_COUNT`, `GREEN` flag\n\n## 2.3 Spatial Data\n\n-   **County Boundaries**: `county20/county20.shp`\\\n-   **Commuting Zone Boundaries**: `cz20/cz20.shp`\\\n-   **Mask Polygon**: `mask_polygon.geojson` (generated via `prepare_mask_polygon.R`)\n\n# 3. Data Preparation\n\n## 3.1 Supply‐Side Wrangling\n\n```         \nlibrary(haven)\nlibrary(dplyr)\n\nccrc_cip_comp <- read_dta(\"ccrc_cip_comp.dta\") %>%\n  mutate(year = as.numeric(year))\n\nsaveRDS(ccrc_cip_comp, \"ccrc_cip_comp.rds\")\n```\n\n## 3.2 Demand‐Side Wrangling\n\n```         \nlibrary(sf)\nlibrary(readr)\nlibrary(dplyr)\n\n# Read commuting zone geometries\nCZ2020 <- st_read(\"cz20/cz20.shp\") %>% select(CZ20 = cz, geometry)\n\n# Read and filter Lightcast data\ncz_raw <- read_csv(\"lightcast-soc-year-county.csv\") %>%\n  filter(GREEN == 1) %>%\n  rename(YEAR = YEAR, green_job_postings = JOB_POSTING_COUNT)\n\n# Merge and simplify\ngz_sf <- cz_raw %>%\n  inner_join(CZ2020, by = \"CZ20\") %>%\n  st_as_sf() %>%\n  st_transform(4326) %>%\n  st_simplify(dTolerance = 0.05)\ngz_sf$id <- seq_len(nrow(gz_sf))\n\nsaveRDS(gz_sf, \"CZ_job_post.rds\")\n```\n\n## 3.3 Mask Polygon Generation\n\n```         \nlibrary(rnaturalearth)\nlibrary(sf)\nlibrary(geojsonio)\n\nus_states <- ne_states(country = \"United States of America\", returnclass = \"sf\")\nus_poly   <- st_union(us_states) %>% st_transform(4326)\n\nworld_poly <- st_sfc(\n  st_polygon(list(matrix(\n    c(-180,-90, 180,-90, 180,90, -180,90, -180,-90),\n    ncol = 2, byrow = TRUE\n  ))),\n  crs = 4326\n)\n\nmask_poly <- st_difference(world_poly, us_poly)\ngeojson_write(mask_poly, file = \"mask_polygon.geojson\")\n```\n\n## 3.4 JSON Export for Front-end\n\n```         \nlibrary(geojsonio)\nlibrary(dplyr)\n\n# Export CZ GeoJSON per year\ncz_df <- readRDS(\"CZ_job_post.rds\")\nfor (yr in unique(cz_df$YEAR)) {\n  geojson_write(\n    filter(cz_df, YEAR == yr),\n    file = sprintf(\"CZData_%d.json\", yr)\n  )\n}\n\n# Export institution GeoJSON per year\ninst_df <- readRDS(\"ccrc_cip_comp.rds\") %>%\n  filter(!is.na(longitude), !is.na(latitude)) %>%\n  st_as_sf(coords = c(\"longitude\", \"latitude\"), crs = 4326) %>%\n  select(year, instnm, inst_perc_green_tot)\n\nfor (yr in unique(inst_df$year)) {\n  geojson_write(\n    filter(inst_df, year == yr),\n    file = sprintf(\"InstituteData_%d.json\", yr)\n  )\n}\n```\n\n## 3.5 Analytic Pipeline & Preparation\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](GreenSeek_pipe.png)\n:::\n:::\n\n\nThe analytic pipeline consists of several R scripts that perform data wrangling, JSON export, and visualization preparation. The key components are: - **Supply-Side Wrangling:** `pre_supply_data.R` reads `ccrc_cip_comp.dta`, coerces `year` to numeric, sorts institution names, and writes `ccrc_cip_comp.rds` for downstream use. - **Demand-Side Wrangling:** `pre_CZ_job_post.R` loads Lightcast CSVs (filtered `GREEN == 1` for 2010–2023), aggregates postings by county/SOC, joins to `county20` and `CZ2020` shapefiles, simplifies geometries (`dTolerance = 0.05`), and saves `CZ_job_post.rds`. - **Mask Polygon Generation:** `prepare_mask_polygon.R` fetches U.S. state boundaries via `rnaturalearth`, unions them, computes the geometric difference from a world polygon to mask out non-contiguous areas, and exports `mask_polygon.geojson`. - **GeoJSON Exports for Front-end:** `pre_cz jason.R` writes per-year CZ GeoJSON files (`CZData_<year>.json`) from `CZ_job_post.rds`. `Pre_supply_json.R` converts `ccrc_cip_comp.rds` into point SF, selects `instnm` and `inst_perc_green_tot`, and exports `InstituteData_<year>.json` for each year. - **Visualization Preprocessing:** `Pre_treemap.R` aggregates green completions by program title, builds a per-year Plotly treemap list (`Green_degree_treemap_plotly_list.rds`). `Pre_Plotly.R` computes time-series of green job proportions by CZ and by SOC, converts ggplots to Plotly objects, and writes `p_CZ_plotly.rds` & `p_SOC_plotly.rds`.\n\n## 3.6 Technical Implementation & Refinement\n\n-   **Initial Prototype:** Started with R’s `mapboxer` package in Shiny but lacked hover support, prompting migration to Mapbox GL JS.\n-   **Simulated Rendering:** Prototyped using one year of real supply data and simulated demand via `tidycensus` for early UI/UX testing.\n-   **Hover & Search Enhancements:** Integrated hover popups on CZ polygons and implemented a Shiny search button for institution fly-to and popups.\n-   **Full Data Integration:** Adopted real 2010–2023 supply and demand data, switched to CZ boundaries, and added a global `selectInput(\"selected_year\")`.\n-   **Performance Tuning:** Split 14-year data into individual JSON files (`CZData_2010.json…CZData_2023.json` and `InstituteData_*.json`), leveraging `fetch(..., {cache: \"force-cache\"})` to reduce redraw time from \\~5s to \\<1s.\n-   **Mask & Tabs:** Added a mask layer (`mask_polygon.geojson`) for contiguous U.S. and organized the Shiny UI into three tabs: Map (interactive map), Supply (treemap), and Demand (time-series).\n\n# 4. Interactive Application\n\n## 4.1 Shiny UI & Server\n\n```         \nlibrary(shiny)\nlibrary(jsonlite)\nlibrary(geojsonio)\nlibrary(dplyr)\nlibrary(sf)\nlibrary(plotly)\n\nsource(\"mapboxtoken_setup.R\")\nccrc_data <- readRDS(\"ccrc_cip_comp.rds\")\ncz_data   <- readRDS(\"CZ_job_post.rds\") %>% mutate(id = row_number())\n\nui <- fluidPage(\n  titlePanel(\"CCRC Green Seek\"),\n  fluidRow(\n    column(4,\n      selectInput(\"selected_year\", \"Year\", choices = sort(unique(cz_data$YEAR))),\n      plotlyOutput(\"treemapPlot\")\n    ),\n    column(8,\n      selectizeInput(\"search_term\", \"Search Institution\", choices = NULL),\n      actionButton(\"search_btn\", \"Search\"),\n      tags$button(\"Clear\", onclick = \"clearMap()\"),\n      div(id = \"map\", style = \"height:600px;\")\n    )\n  ),\n  fluidRow(\n    column(6, plotlyOutput(\"cz_plot\")),\n    column(6, plotlyOutput(\"trendPlot\"))\n  )\n)\n\nserver <- function(input, output, session) {\n  observe({\n    req(input$selected_year)\n    insts <- ccrc_data %>%\n      filter(year == input$selected_year) %>%\n      pull(instnm) %>%\n      unique() %>%\n      sort()\n    updateSelectizeInput(session, \"search_term\", choices = insts, server = TRUE)\n    session$sendCustomMessage(\"loadYear\", input$selected_year)\n    session$sendCustomMessage(\"loadInstituteYear\", input$selected_year)\n  })\n  observeEvent(input$search_btn, {\n    res <- ccrc_data %>%\n      filter(instnm == input$search_term, year == input$selected_year) %>%\n      slice(1)\n    if (nrow(res)) {\n      popup <- paste0(\"<strong>\", res$instnm, \"</strong><br>Green %: \",\n        sprintf(\"%.1f%%\", res$inst_perc_green_tot * 100))\n      session$sendCustomMessage(\"updateSearch\", list(\n        lng = res$longitude, lat = res$latitude, popup = popup\n      ))\n    }\n  })\n  output$treemapPlot <- renderPlotly({\n    readRDS(\"Green_degree_treemap_plotly_list.rds\")[[as.character(input$selected_year)]]\n  })\n  output$cz_plot    <- renderPlotly(readRDS(\"p_CZ_plotly.rds\"))\n  output$trendPlot  <- renderPlotly(readRDS(\"p_SOC_plotly.rds\"))\n}\n\nshinyApp(ui, server)\n```\n\n## 4.2 Mapbox Front-end (mapbox.js)\n\n```         \nmapboxgl.accessToken = mapboxToken;\nconst map = new mapboxgl.Map({\n  container: 'map',\n  style: 'mapbox://styles/mapbox/navigation-day-v1',\n  center: [-95, 40],\n  zoom: 3.5\n});\n\nfunction loadCZData(year) {\n  fetch(`CZData_${year}.json`)\n    .then(res => res.json())\n    .then(data => {\n      if (map.getSource('cz')) {\n        map.getSource('cz').setData(data);\n      } else {\n        map.addSource('cz', { type: 'geojson', data });\n        map.addLayer({\n          id: 'cz-layer',\n          type: 'fill',\n          source: 'cz',\n          paint: { /* color & opacity settings */ }\n        });\n      }\n    });\n}\n\nfunction loadInstituteData(year) {\n  fetch(`InstituteData_${year}.json`)\n    .then(res => res.json())\n    .then(data => {\n      if (!map.getSource('institutes')) {\n        map.addSource('institutes', { type: 'geojson', data });\n        map.addLayer({\n          id: 'institutes-layer',\n          type: 'circle',\n          source: 'institutes',\n          paint: {\n            'circle-radius': [\n              'interpolate', ['linear'], ['get', 'inst_perc_green_tot'],\n              0, 4, 1, 12\n            ]\n          }\n        });\n      } else {\n        map.getSource('institutes').setData(data);\n      }\n    });\n}\n\nShiny.addCustomMessageHandler('loadYear', loadCZData);\nShiny.addCustomMessageHandler('loadInstituteYear', loadInstituteData);\nShiny.addCustomMessageHandler('updateSearch', coords => {\n  map.flyTo({ center: [coords.lng, coords.lat], zoom: 6 });\n  new mapboxgl.Popup()\n    .setLngLat([coords.lng, coords.lat])\n    .setHTML(coords.popup)\n    .addTo(map);\n});\n\nmap.on('mousemove', 'cz-layer', e => { /* hover effect */ });\nmap.on('mouseleave', 'cz-layer', () => { /* remove hover */ });\nwindow.clearMap = () => map.flyTo({ center: [-95, 40], zoom: 3.5 });\n```\n\n# 5. APP UI Key Features\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](GreenSeek_UI.png)\n:::\n:::\n\n\n# 6. Conclusions & Next Steps\n\n-   The interactive map and time-series charts reveal spatial disparities in green job demand and highlight regions where community colleges may need to expand their green programs.\n-   Future enhancements include demographic filters (race, gender), predictive modeling, and user-uploaded data integration.\n\n## 6.1 Future Extensions & Reusability\n\nThis R preprocessing + Mapbox GL JS pipeline can ingest new supply/demand datasets by replacing JSON export scripts. Future enhancements may include demographic filtering, predictive analytics tabs, and user data uploads, building on the existing Shiny + Mapbox framework.\n\n# 7. Repository\n\nFull code and documentation available at:\n\n[GitHub · wwang93/CCRC_GreenSeek-Mapping](https://github.com/data-edu/CCRC_GreenSeek-Mapping)\n\n# 8 Full Paper\n\nFor comprehensive analysis, methodology, and further implications:\n\n[Access the Full Paper (Google Doc)](https://docs.google.com/document/d/1LTAZ0IIExay1CJED3lBWcX2EgHtEvtr7DgBAOsYtaI8/edit?tab=t.0)\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}